<!DOCTYPE html>
<html>

<head>
    <title>http-vis</title>

    <meta charset='utf-8'>

    <script src="vendor/jquery-1.9.1.min.js"></script>
    <script src="vendor/underscore-min.js"></script>
    <script src="vendor/d3.v3.min.js"></script>
    <script src="vendor/packet.js"></script>
    <script src="vendor/http-parser.min.js"></script>
    <script src="vendor/bootstrap-filestyle-0.1.0.min.js"></script>

    <script src="js/Capture.js"></script>
    <script src="js/Stripes.js"></script>
    <script src="js/Histogram.js"></script>
    <script src="js/Palette.js"></script>

    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap-responsive.css">

    <style type="text/css">
        body {
            padding-top: 40px;
            background-color: black;
        }
        #options {
            position: absolute;
            top: 35px;
            left: auto;
            right: 20px;
            max-width: none;
            width: 270px;
            margin-top: 10px;
            float: right;
        }
        #options .arrow {
            left: auto;
            right: 53px;
        }
        #options .popover-content {
            text-align: center;
        }
        #options .popover-content input, #options .popover-content select {
            width: 242px;
        }
        #options .network-arrow {
            font-size: 16px;
        }
        #options label {
            text-align: left;
            font-weight: bold;
        }

        #loading {
            margin-right: 0.5em;
            display: none;
        }

        #histogram-container svg {
            height: 100px;
        }

        .navbar-inner>.container {
            width: auto;
            padding: 0 20px;
            text-align: left;
        }

        #navbar-info {
            font-family: "Courier New";
        }

        #navbar-info>* {
            display: inline-block;
        }

        #time-info   { width: 4em; }
        #tcp-info    { width: 6em; }
        #http-info   { width: 6em; }
        #packet-info { width: 9em; }
    </style>
</head>

<body>
    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="container">
                <a class="brand" href="#">http-vis</a>
                <!--<p class="navbar-text pull-left">Every packet matters.</p>-->
                <form class="navbar-form pull-right" style="margin-left: 4px;">
                    <div class="btn-group">
                        <button id="options-toggle" disabled class="btn dropdown-toggle"><i class="icon-wrench"></i></button>
                    </div>
                    <button id="download-button" disabled class="btn"><i class="icon-download"></i></button>

                    <div id="options" class="popover bottom">
                        <div class="arrow"></div>
                        <h3 class="popover-title">Options</h3>
                        <div class="popover-content">
                            <label>Filtering and bandwidth</label>
                            <select id="server-dropdown"></select>
                            <div class="network-arrow" style="margin-top: 7px;">⇓</div>
                            <div class="input-append">
                                <input id="bandwidth-input" style="width: 3em;" type="text">
                                <span class="add-on">kbps</span>
                            </div>
                            <div class="network-arrow" style="margin-top: -3px;">⇓</div>
                            <select id="client-dropdown"></select>

                            <label style="margin-top: 30px;">Color packets by</label>
                            <select id="color-dropdown">
                                <option>stream</option>
                                <option>domain</option>
                                <option>content-type</option>
                            </select>

                            <label style="margin-top: 30px;">Width</label>
                            <div class="input-append">
                                <input disabled id="time-input" style="width: 2em;" type="text">
                                <span class="add-on">s</span>
                            </div>
                            ×
                            <div class="input-append">
                                <input id="width-s-input" style="width: 1.8em;" type="text">
                                <span class="add-on">px</span>
                            </div>
                            =
                            <div class="input-append">
                                <input id="width-input" style="width: 2.4em;" type="text">
                                <span class="add-on">px</span>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="navbar-form pull-right">
                    <input id="file-chooser" type="file">
                </form>
                <p id="navbar-info" class="navbar-text">
                    <span id="loading">loading...</span>
                    <span id="time-info"></span>
                    <span id="tcp-info"></span>
                    <span id="http-info"></span>
                    <span id="packet-info"></span>
                </p>
            </div>
        </div>
    </div>

    <div id="histogram-container">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
        </svg>
    </div>

    <div id="stripes-container">
        <!--
        <?xml version="1.0" encoding="UTF-8" ?>
        <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" [
            <!ATTLIST rect packet-id CDATA #IMPLIED>
        ]>
        -->
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
            <style type="text/css">
                svg {
                    shape-rendering: crispEdges;
                    font-size: 24px;
                }

                rect.stream {
                    fill: #FFF;
                    fill-opacity: 0.7;
                    /*
                    stroke: grey;
                    stroke-width: 0.1em;
                    stroke-opacity: 0.5;
                    */
                }

                rect.request {
                    fill: #000;
                    fill-opacity: 0.4;
                }

                rect.response {
                    fill: #005;
                    fill-opacity: 0.25;
                }

                rect#background {
                    fill: black;
                }
            </style>
            <rect id="background" width="100%" height="100%"></rect>
        </svg>
    </div>

    <script>
        var stripes_svg = $('#stripes-container>svg')
          , histogram_svg = $('#histogram-container>svg')

        var width = $(document).width()
        stripes_svg.attr('width', width + 'px')
        histogram_svg.attr('width', width + 'px')

        var stripes = new Stripes(stripes_svg[0])
        var stacked = new Histogram(histogram_svg[0])

        var capture, filtered_capture, palette, color_by = 'stream', bandwidth, duration

        function draw() {
            stripes.draw(filtered_capture, palette, bandwidth)
            stacked.draw(filtered_capture, palette, bandwidth, 125)
        }

        function filter(client, server) {
            if (client === 'any client') client = undefined
            if (server === 'any server') server = undefined
            filtered_capture = capture.filter(client, server)
            var kbit = filtered_capture.bandwidth()
            $('#bandwidth-input').val(Math.round(kbit))
            bandwidth = kbit * 1000 / 8
            duration = filtered_capture.duration(bandwidth)
            palette = new Palette(filtered_capture, color_by)
        }

        function options(dropdown, options) {
            dropdown.html(options.map(function(text) { return '<option>' + text + '</option>'}).join(''))
        }

        $("#file-chooser").filestyle({
            buttonText: 'Choose PCAP file',
            icon: true,
            classIcon: 'icon-folder-open',
            textField: false
        }).change(function() {
            $('#loading').show()
            var file = this.files[0]
            var reader = new FileReader()

            reader.readAsArrayBuffer(file)
            reader.onload = function() {
                var pcap = new DataView(reader.result)

                capture = new Capture(pcap)
                filter(undefined, undefined)
                draw()

                options($('#client-dropdown'), ['any client'].concat(capture.clients()))
                options($('#server-dropdown'), ['any server'].concat(capture.servers()))
                $('#time-input').val(Math.round(duration*10)/10)
                $('#width-input').val(Math.round(width))
                $('#width-s-input').val(Math.round(width / duration))
                $('#options-toggle').prop('disabled', false)
                $('#download-button').prop('disabled', false)
                $('#loading').hide()
            }
        })

        var options_panel = $('#options'), options_toggle = $('#options-toggle')
        options_toggle.click(function() {
            options_toggle.parent().toggleClass('open')
            options_panel.toggle()
            return false
        })
        $('body').click(function(event) {
            if (options_panel.has(event.target).length === 0) {
                options_panel.hide()
                options_toggle.parent().removeClass('open')
            }
        })

        $('#download-button').click(function() {
            stripes.download()
            return false
        })

        $('#color-dropdown').change(function() {
            color_by = this.selectedOptions[0].innerHTML
            palette = new Palette(filtered_capture, color_by)
            draw()
        })

        $('#bandwidth-input').change(function() {
            bandwidth = Number(this.value) * 1000 / 8
            draw()
        })

        $('#width-input').change(function() {
            stripes_svg.attr('width', this.value + 'px')
            histogram_svg.attr('width', this.value + 'px')
            $('#width-s-input').val(Math.round(this.value / duration))
        })

        $('#width-s-input').change(function() {
            $('#width-input').val(Math.round(this.value * duration)).change()
        })

        var clients_dropdown = document.getElementById('client-dropdown')
          , servers_dropdown = document.getElementById('server-dropdown')
        clients_dropdown.onchange = servers_dropdown.onchange = function filter_change() {
            var selected_client = clients_dropdown.selectedOptions[0].innerHTML
            var selected_server = servers_dropdown.selectedOptions[0].innerHTML
            filter(selected_client, selected_server)
            draw()
        }

        var time_info = $('#time-info')
        stripes.onmousemove = function(time) {
            time_info.text(time.toFixed(2) + 's')
        }

        var hide_timeout, packet_info = $('#packet-info'), tcp_info = $('#tcp-info'), http_info = $('#http-info')
        stripes.onmouseover = function(stream, transaction, packet) {
            if (packet) {
                packet_info.text('packet #' + packet.id)
                //tcp_info.text('TCP #' + stream.id)
                http_info.text('HTTP #' + transaction.id)
                clearTimeout(hide_timeout)
            } else {
                hide_timeout = setTimeout(function() {
                    packet_info.text('')
                    //tcp_info.text('')
                    http_info.text('')
                }, 200)
            }
        }
    </script>

</body>

</html>
